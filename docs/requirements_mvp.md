# 資金管理アプリ 要求定義（MVP）
**対象実装**: Next.js 16 / App Router / TypeScript  
**目的**: 初心者でも理解できる入力UIで、戦略の基本統計（勝率・平均利益%・平均損失%）と資金・停止ラインから、**推奨の建玉金額（投入額）**と**推奨の損切り幅（%）**を算出して提示する。

---

## 1. 背景と狙い
トレードの破産（資金の急減）を避けるためには「1回の取引でどれだけの損失を許容するか（リスク率）」と「その許容損失に対して建玉をどれだけ持つか（投入額）」を整合させる必要がある。  
本アプリは、ユーザーが入力（または外部で導出）した戦略指標を用い、**破産しにくい初期設定**を自動提案する。

---

## 2. MVPの前提（合意済み）
- **停止ライン（破産ライン）**: 初期資金 `E0` の `L%` を下回ったら停止（強制終了）とみなす  
  - `L` はユーザー変更可能（デフォルト 50%）
- **データ取得**:
  - 優待（株）: 別アプリで導出済の `p / W% / D%` を手入力
  - 先物・FX: **Backtesting.py**で導出した値を手入力（MT4/MT5連携はMVPでは採用しない）
- **トレード統計の解釈**:
  - `W%` と `D%` は **「1トレードあたりの%」**として扱う（複利・レバ込みでもOK）
- **損切り幅（%）の推奨**:
  - MVPは `stop% = D% × s_loss`（将来：分位点/ATRへ拡張）

---

## 3. 用語・記号（内部変数）
- `E0`：初期資金（円）
- `L`：停止ライン（初期資金比の%）例：50% → `L=0.5`
- `p`：勝率（0〜1）
- `W%`：勝ったときの平均利益（%）
- `D%`：負けたときの平均損失（%）※正の値で入力
- `b`：ペイオフ比（`b = W% / D%`）
- `N`：想定トレード回数（回）
- `α`：停止ライン割れ確率の目安（0〜1）
- `k`：ケリー抑制係数（0〜1）
- `s_loss`：損失の安全倍率（≥1）
- `f_user_max`：ユーザー上限（1回の最大損失率：資金に対する%）

---

## 4. 対象ユーザー
- 投資初心者〜中級者
- 「勝率」「平均利益%」「平均損失%」が手元にあるが、建玉や損切り幅の整合が取れていないユーザー

---

## 5. モード設計（UIは別）
### 5.1 優待イベント投資（株）モード
- 入力: `p, W%, D%` は別アプリで導出済 → 本アプリへ手入力
- デフォルトは比較的マイルド（ただしギャップ想定あり）

### 5.2 先物・FX（Backtesting.py）モード
- 入力: Backtesting.pyで得た `p, W%, D%` を手入力
- デフォルトはより保守的（レバ・急変動の可能性）

---

## 6. 入力仕様（MVP）
### 6.1 基本入力（必須）
- 初期資金（円）: `E0`
- 停止ライン（%）: `L`（デフォ 50%）
- 勝率（%）: `p%`（内部で0〜1に変換）
- 勝ったときの平均利益（%）: `W%`
- 負けたときの平均損失（%）: `D%`

> 補足: MVPでは `W%` と `D%` の入力を基本とする（初心者が混乱しにくい）。  
> `b`（ペイオフ比）は「詳細」表示で自動計算し、必要なら上書き入力を許容（オプション）。

### 6.2 詳細設定（任意・デフォあり）
- 想定トレード回数（回）: `N`
- 停止ラインを割る確率の目安（%）: `α`
- 攻めすぎ防止（ケリー抑え）: `k`
- 損切りゆとり（損失の安全倍率）: `s_loss`
- 1回の最大損失（資金に対して%）: `f_user_max`

---

## 7. 出力仕様（MVP）
### 7.1 主要出力
- **おすすめ建玉（投入額）**: `position_notional`（円）
- **おすすめ損切り幅**: `stop%`（%）

### 7.2 参考出力（初心者にも分かる表現）
- この設定だと **1回で最大いくら負ける？**: `risk_amount`（円）
- **資金に対する1回の最大損失（%）**: `f`（%）
- （参考）期待値（%）: `EV = p*W% - (1-p)*D%`
- （参考）ペイオフ比: `b`

---

## 8. 計算ロジック（MVP）

### 8.1 前処理
- `p = p_percent / 100`
- `b = W% / D%`

### 8.2 損切り幅（%）の推奨
- `stop% = D% × s_loss`

### 8.3 1回あたりリスク率 `f` の推奨（内部値）
#### (A) ケリー上限（攻めの理論値を上限化）
- `f_kelly = max(0, p - (1 - p) / b)`
- `f_kelly_cap = k × f_kelly`

#### (B) 停止ライン（フロア）上限（破産しにくさ優先）
「N回のうちに m 連敗が起こる確率が α 以下」になる最小の `m` を探索（保守近似）:
- `P(exists m-loss-streak) ≤ (N - m + 1) × (1 - p)^m`
- これが `≤ α` となる最小 `m` を採用

その `m` 連敗でも停止ライン `L` を割らないための上限:
- `f_floor = 1 - L^(1/m)`

#### (C) 最終推奨リスク率
- `f = min(f_kelly_cap, f_floor, f_user_max)`

> Note: αやNは「目安の安全度」を決める入力。モデル近似のため**保証ではない**。

### 8.4 建玉（投入額）の推奨
- `risk_amount = f × E0`
- `position_notional = risk_amount / (stop% / 100)`

---

## 9. デフォルト値（提案：破産しにくい寄り）
### 9.1 優待（株）
- `N = 60`
- `α = 0.01`（1%）
- `k = 0.25`
- `s_loss = 1.10`
- `f_user_max = 0.010`（1.0%）

### 9.2 先物・FX（Backtesting.py）
- `N = 200`
- `α = 0.005`（0.5%）
- `k = 0.10`
- `s_loss = 1.20`
- `f_user_max = 0.003`（0.3%）

---

## 10. UI/UX要件（初心者向け）
- 基本入力は「円」「%」を明確に表示（単位を必ず添える）
- 詳細設定は折りたたみ（Accordion）
- 計算結果は上から
  1) おすすめ建玉（円）
  2) おすすめ損切り幅（%）
  3) 1回で最大いくら負ける（円）
- 「なぜその値になったか」(fの制約がどれで決まったか、mはいくつか) を詳細に表示（透明性）
- 注意文（免責）を短文で表示

---

## 11. 入力バリデーション（MVP）
- `E0 > 0`
- `0 < L < 1`（UIは%入力: 10〜90%などの範囲推奨）
- `0 < p < 1`（UIは1〜99%推奨）
- `W% > 0`, `D% > 0`
- `N >= 1`
- `0 < α < 1`
- `0 <= k <= 1`
- `s_loss >= 1`
- `0 < f_user_max < 1`

---

## 12. エラーメッセージ（例）
- 「勝率が極端です。入力値を確認してください（例：1%未満/99%超）。」
- 「平均損失が0になっています。Backtesting.pyの値を確認してください。」
- 「停止ラインが高すぎると、すぐ停止しやすくなります。」

---

## 13. 非機能要件（MVP）
- **保存**: LocalStorageに前回入力を保存（モード別に保存）
- **動作**: すべてクライアントで計算（即時反映）
- **環境**: Next.js 16 / TypeScript
- **UI**: Tailwind + shadcn/ui（Input / Slider / Tooltip / Accordion）

---

## 14. 将来拡張（スコープ外）
- トレード損失分布の分位点（例：90%点）で `stop%` を推奨
- ATRベースのストップ提案
- stats.json貼り付け/アップロードで自動入力
- モンテカルロでの停止ライン割れ確率推定（近似の代替）
- 銘柄別・複数戦略のポートフォリオ配分

---

## 15. 受け入れ基準（MVP）
- 入力（E0, L, p, W%, D%）を埋めると、即時に  
  `stop%`, `position_notional`, `risk_amount`, `f` が表示される
- 詳細設定を変更すると結果が即時更新される
- エラー入力は計算停止または警告が出る
- 入力がLocalStorageに保存され、リロード後に復元される
